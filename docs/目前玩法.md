# Koniavacraft 目前玩法總覽（NeoForge 1.21.1）

> 面向玩家與開發者的精簡說明，描述現有系統、進展節點與已知限制，並附上下一步擴展建議。

## 世界與資源
- 基礎方塊：`mana_block`、`mana_soil`、`deep_mana_soil`、`mana_grass_block`、礦石（一般/深板岩）。
- 基礎素材：`mana_dust` 系列、`mana_ingot`、`mana_crystal_fragment` 等。

## 能源與流體系統（Mana/RF）
- 統一魔力介面：以 `IUnifiedManaHandler`/`ManaStorage` 表示存量、收/出、模擬與多槽接口。
- 資料元件（Data Components）：
  - `TECH_WAND_MODE`（工具模式）、`SAVED_BLOCK_POS`、`SAVED_DIRECTIONS`、`CONFIGURED_DIRECTIONS(_IO)` 等。
  - 用於 GUI/Tooltip 顯示與網路同步，避免分散 NBT 流程。

## 機器與裝置
- Mana Generator（發電機）
  - 功能：燃料→Mana/RF 產出。支援鄰接能力快取（Mana/RF）與 I/O 配置。
  - 介面：`ManaGeneratorMenu/Screen`，客戶端定期同步（目前約每 10 tick）。

- Mana Infuser（灌注台）
  - 功能：以 `ManaInfuserRecipe` 將輸入強化為輸出，消耗 mana（資料驅動）。
  - 介面：`ManaInfuserMenu/Screen`，配合 JEI 類別。

- Mana Crafting Table（魔力合成台）
  - 功能：9 宮格合成與 mana 成本，支援 Shaped/Unshaped；有 Recipe 快取與查詢時間保護。
  - 介面：`ManaCraftingMenu/Screen`，JEI 類別與 Plugin 已接上。

- Solar Mana Collector（太陽魔力收集器）
  - 功能：晝夜條件收集 mana，支援升級與 I/O 配置；鄰接能力快取。

- Arcane Conduit（導管）
  - 功能：在網路中轉輸 mana，具本地緩衝、I/O 與優先級；提供配置 GUI。
  - 設計：`IOManager/StatsManager/CacheManager/NetworkManager/TransferManager/PullManager` 分工；`tickOffset` 分散掃描負載。

## 物品與工具
- Basic Tech Wand（科技魔杖）
  - 模式切換（Data Component）：配置 I/O、保存方向設定、開啟通用配置 GUI 等。
  - 網路：使用 `CustomPacketPayload` 系列封包（NeoForge 1.21.1 模式）。

- Mana Debug Tool（除錯工具）
  - 快速檢視/修改 Mana，輔助測試。

- 升級（Upgrades）
  - 目前：`SPEED_UPGRADE/EFFICIENCY_UPGRADE` 與 `UpgradeMenu/Screen`。
  - 接口：`IUpgradeableMachine`、`UpgradeInventory` 等。

### 魔力發電機專用升級
魔力發電機擁有一套獨特的升級系統，允許玩家在「速度」與「效率」之間做權衡取捨。
- **加速處理元件 (Accelerated Processing Upgrade)**
  - **作用：** 縮短燃料的總燃燒時間。
  - **效果：** 大幅提升每秒的魔力/能量產出**速率**，但代價是**降低**單一燃料的總產出**效率**。
  - **適用情境：** 需要瞬間巨大能量、或以無限燃料換取時間的後期玩法。

- **擴展燃料室 (Expanded Fuel Chamber Upgrade)**
  - **作用：** 延長燃料的總燃燒時間。
  - **效果：** 讓單一燃料燃燒得更久，減少更換燃料的頻率，但輸出速率不變。
  - **適用情境：** 希望延長自動化發電機的運作週期，不常補充燃料的場合。

- **催化轉換器 (Catalytic Converter Upgrade)**
  - **作用：** 提升每 tick 的魔力/能量產出量。
  - **效果：** 在不改變燃燒時間的情況下，直接提升燃料的總產出**效率**。這是唯一能讓一塊煤炭產出更多能量的升級。
  - **適用情境：** 希望最大化燃料價值，用最少的燃料產出最多能量的場合。

- **診斷顯示儀 (Diagnostic Display Upgrade)**
  - **作用：** UI 增強。
  - **效果：** 安裝後，可以在機器的介面中看到更詳細的運作統計數據（此為純資訊顯示，不影響性能）。
  - **適用情境：** 希望精確監控發電機狀態，進行數據化管理的玩家。

## 配方與資料生成
- 配方類型：`mana_crafting`、`mana_infuser`、`mana_fuel`（Generator 使用）。
- Datagen：統一輸出至 `src/generated/resources`。JEI/類別已對應。

## 客戶端與 GUI 框架
- ScreenAPI：可拖曳視窗、Tooltip、材質化按鈕等通用元件。
- 通用配置 GUI：`UniversalConfigMenu/Screen`，方向 I/O、優先級文字輸入（區分正負、範圍守衛）。

## 網路與同步
- 採用 PayloadRegistrar/StreamCodec 的註冊與同步；客端/伺服分流類註冊檔齊備。
- 常見封包：導管優先級更新、I/O 切換、工具模式、玩家裝備 GUI 開啟等。

---

## 已知特性與限制（開發觀察）
- 同步頻率：部分機器以固定 tick 間隔同步客戶端，尚未全面導入「髒資料旗標 + 合併節流」。
- Cache/Unload：導管網路與鄰接快取較完整，但跨區塊卸載/重載後的恢復與失效時機需持續驗證。
- 視覺狀態：多數機器已具備基本工作/待機顯示，過載/溢流等擴展狀態仍有發揮空間。
- Data Components：已用於部分狀態（模式/方向），可再擴展至容量/效率/不穩定度等統一展示。

---

## 近期擴展建議（高價值小步驟）
- 導管 Analyzer 視覺疊加（世界渲染）
  - 顯示段吞吐、方向箭頭與瓶頸著色；近距離高細節、遠距離簡化。
  - 鉤點：`RenderLevelStageEvent`；資料：由 NetworkManager 提供快照。

- 同步節流改進
  - 改以髒旗標（狀態改變才同步）+ 多變更合併，降低封包數與抖動。
  - 套用對象：Generator、Collector、Infuser、Conduit。

- Mana Regulator（緩衝調節器）
  - 平滑輸出、上/下限檔位、過壓保護；提供簡單 GUI 與 JEI 說明。
  - 與導管並用以穩定產線，減少尖峰。

- JEI/EMI 類別補強
  - `mana_fuel` 類別：燃料→產率/副產顯示；`mana_infuser`/`mana_crafting` 動畫進度。

- Data Component 擴展
  - 統一設備屬性（容量/效率/不穩定度/溫度）至 Component，Tooltip/同步一致；保留 Capability 互通。

---

## 中期玩法解鎖（T1→T3 節點）
- T1：基礎收集（Solar）→ 基礎導管 → 合成台/灌注入門；升級卡基礎。
- T2：發電機多燃料與環境加成 → Regulator/Router/Filter 導入 → 儀式配方（天氣/月相/群系條件）。
- T3：高階導管（吞吐/損耗/射程提升）→ 多方塊 Ritual Altar → Augment 系統與網路健診。

---

## 路線圖（Roadmap）
- 視覺：所有機器統一「待機/加工/過載」三態特效；導管流量粒子與遠距離簡化線框。
- 網路：導入網路健康度快照與 GUI 顯示；跨區塊卸載/恢復測試與修補。
- 配方：條件型配方（天氣/月相/維度/標籤）；JEI/EMI 類別對齊。
- 教學：Nara 系統導引，結合進度（Advancements）串連 T1→T3。

---

## 開發者提示
- 伺/客分離：注意 `Dist.CLIENT` 限定與客端註冊階段；封包 handler 切回主執行緒。
- 效能：避免每 tick 物件分配；導管網路用快取+TTL；配方查詢已有限速（1ms 目標）。
- 國際化：避免硬編碼字串，統一 `translatable`；日誌請使用 `LOGGER`。

（本文件將隨功能落地持續更新）