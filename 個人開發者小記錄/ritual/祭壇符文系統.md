# 祭壇符文系統代碼整理

> 更新日期：2025-09-27
> 來源路徑：
> - `src/main/java/com/github/nalamodikk/common/block/ritualblock`
> - `src/main/java/com/github/nalamodikk/common/block/blockentity/ritual`

## 1. 模組概觀
- 儀式相關功能分成 **方塊層 (Blocks)** 與 **方塊實體層 (BlockEntities)**。
- 核心流程由 `RitualCoreBlock` / `RitualCoreBlockEntity` 主導，周邊以 `ArcanePedestal`、`RuneStone`、`ManaPylon`、`ChalkGlyph` 等結構支撐。
- 目前多數儀式邏輯尚留 `TODO`，但資料結構與序列化框架已經到位，可作為後續實作基礎。

## 2. 方塊類別一覽 (`common.block.ritualblock`)
| 類別 | 角色定位 | 重要屬性 / 方法 | 特殊備註 |
| --- | --- | --- | --- |
| `ArcanePedestalBlock` | 儀式祭品基座，處理玩家插取物品 | - `useWithoutItem`：伺服端交給 `ArcanePedestalBlockEntity` 插入/取出祭品<br>- `getTicker`：區分客戶端/伺服端 tick | 失去方塊時自動丟出祭品 (`dropContents`) |
| `ChalkGlyphBlock` | 粉筆符號 (超薄覆蓋物) | - 方塊狀態：`COLOR`, `PATTERN`<br>- `useWithoutItem`：同色粉筆點擊切換圖案 | 需下方實體支撐，型態為 0.5 高薄層 |
| `ManaPylonBlock` | 儀式魔力塔 | - `useWithoutItem`：顯示儲量與連線狀態<br>- `getTicker`：呼叫 `ManaPylonBlockEntity#tick` | 由 BlockEntity 負責魔力網絡互動 |
| `RitualCoreBlock` | 儀式核心方塊 | - `useWithoutItem`：檢查催化劑→啟動儀式<br>- `getTicker`：轉呼叫 `RitualCoreBlockEntity#tick` | 方塊移除時掉落產物暫存 |
| `RuneStoneBlock` | 四系符文增幅方塊 | - 建構子指定 `RuneType`<br>- `useWithoutItem`：給玩家顯示效果說明 | `RuneType` 決定效果與顏色 |
| `RuneType` | 符文種類列舉 | - `calculateEffect`：依數量計算增益<br>- `getTranslationKey`：語系鍵 | 提供顏色 (ARGB) 與堆疊上限資訊 |

## 3. 方塊實體類別一覽 (`common.block.blockentity.ritual`)
| 類別 | 主要功能 | 核心資料欄位 / API | 未完成或注意事項 |
| --- | --- | --- | --- |
| `ArcanePedestalBlockEntity` | 管理祭品槽、旋轉動畫、同步粒子 | - 單槽 `items[0]`<br>- `insertOffering` / `extractOffering` / `consumeOffering`<br>- `serverTick`：粒子 + TODO 連動 Ritua Core<br>- `clientTick`：旋轉/浮動動畫 | `serverTick` 內仍保留與核心同步的 TODO |
| `ManaPylonBlockEntity` | 儲存/抽取魔力，提供儀式能源 | - `ManaStorage` 容量 500k<br>- `BlockCapabilityCache` 追蹤六向導管<br>- `attemptManaExtraction` 每 5 tick 抽取<br>- `provideManaForRitual` 供核心呼叫 | 需要與導管系統 (`ModCapabilities.MANA`) 成功建立能力快取 |
| `RitualCoreBlockEntity` | 儀式狀態機、配方框架 | - `ManaStorage` 容量 1M<br>- `structureValidator` / `materialValidator` 檢查基座布局、符文份量、祭品清單<br>- `attemptStartRitual` 驗證通過後扣除催化劑並鎖定配方<br>- `progressRitual` 依配方時間切割魔力脈衝<br>- `generateRitualResults` 輸出配方主產物與額外獎勵 | `onPedestalContentsChanged()` 可在基座變動時中止儀式並提示 |
| `RitualRecipe` | 儀式配方定義 | - `RitualInput`：傳入祭品列表、魔力與結構條件<br>- `matches`：檢查材料 + 魔力<br>- `Serializer`、`StreamCodec`：支援註冊/網路同步 | 結構需求以 `Map<String,Integer>` 寫死，尚未整合至核心邏輯 |

### 2.1 符文石外觀
- **效率符文石**：低矮方柱，上方嵌入六格高的晶核，材質 `textures/block/rune_stone_efficiency.png`。
- **迅捷符文石**：細長石柱造型，底座高度 5 格，上段延伸至 16 格以呈現加速度感 (`rune_stone_celerity.png`)。
- **穩定符文石**：寬厚基座搭配覆蓋護蓋，重心偏低以呼應防護定位 (`rune_stone_stability.png`)。
- **增幅符文石**：三段式階梯加尖頂晶石，象徵能量聚焦 (`rune_stone_augmentation.png`)。
- 模型由資料生成器輸出多段元素 (`ModBlockStateProvider.runeStoneBlock`)，確保渲染幾何與碰撞盒、Outline 一致。

| （已整併） | － | `RitualRecipe.Serializer` 現為唯一序列化入口 | 透過單一路徑維護 Codec / StreamCodec，減少重複程式碼 |
| `RuneStoneBlockEntity` | 計算符文增益、提供渲染狀態 | - `RuneEffect` 子類統一描述效果<br>- `checkForNearbyRituals` 改用 `RitualCoreTracker` 快取核心清單<br>- `countNearbyRuneStones` 計算同類符文堆疊<br>- `checkSynergyEffects` 檢查協同條件 | 建議後續改為核心事件廣播以取代固定週期掃描 |

## 4. 互動流程摘要
1. 玩家在 `ArcanePedestalBlock` 放入祭品 → `ArcanePedestalBlockEntity` 顯示動畫。
2. 玩家手持 `ResonantCrystalItem` 或 `VoidPearlItem` 右鍵 `RitualCoreBlock` → `attemptStartRitual()`。
3. `RitualCoreBlockEntity` 進入 `PREPARING` 狀態：`RitualStructureValidator` 檢查基座四向、魔力塔距離與符文份量，`RitualMaterialValidator` 驗證祭品是否符合配方。
4. 驗證成功後進入 `RUNNING`，依配方時間切割魔力脈衝；能量不足會立即將狀態轉為 `FAILED`。
5. `ArcanePedestalBlockEntity` 透過追蹤器通知核心祭品變動，核心會中止正在進行的儀式並提示附近玩家。
6. 儀式完成時填入 `resultItems`；`dropContents` 可由世界事件或玩家領取。
7. `RuneStoneBlockEntity` 改以 `RitualCoreTracker` 查詢核心，訪問成本降低，後續可再導入事件廣播。

## 5. 未完成項目與建議
- **結構驗證**：`RitualCoreBlockEntity` 仍然缺少對粉筆圖案、基座方向、魔力塔距離等的真正檢查，建議優先實作並提取成獨立 `StructureValidator`。
- **配方序列化統一**：`RitualRecipe.Serializer` 現為唯一序列化入口，未來擴充僅需維護單一路徑。
- **Rune 搜索成本**：`RuneStoneBlockEntity#checkForNearbyRituals` 每 tick 掃描大量方塊，後續可改為核心廣播或事先索引。
- **魔力同步**：`ArcanePedestalBlockEntity.serverTick` 標記與核心的同步邏輯待補，確保祭品消耗後能通知核心。
- **顯示/翻譯**：多處使用硬編碼中文描述（例如 rune 類型說明），建議改為 `Component.translatable`，減少語系重複。

## 6. 相關文件
- `spec.md`：資料模型章節新增儀式方塊族群摘要。
- `api.md`：版本 0.1.13 記錄此次整理作業。
- 語系鍵：`assets/koniava/lang/en_us.json` / `zh_tw.json` 中的 `message.koniavacraft.*`、`tooltip.koniavacraft.rune_stone_*`。

---
若有新功能（例：儀式配方資料包、符文協同效果）進入實作，建議同步更新本檔與主規格文件，以維持交付一致性。
